<div class="orders-container" style="position: relative;">
    <!-- Header with Search and Stats -->
    <div class="orders-header-styled"
        style="padding: 24px; background: white; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 800; color: #111827;">Gesti√≥n de Pedidos</h2>
                <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 0.9rem;">Administra y monitorea tus pedidos en
                    tiempo real.</p>
            </div>

            <div style="display: flex; align-items: center; gap: 12px;">
                <div *ngIf="isLoading" class="mini-spinner-styled"></div>

                <!-- Bot√≥n Refrescar -->
                <button class="icon-btn-styled" (click)="loadOrders()" title="Actualizar Pedidos"
                    style="background: #f3f4f6; border: none; padding: 10px; border-radius: 8px; cursor: pointer; color: #4b5563;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                        <polyline points="21 3 21 8 16 8"></polyline>
                    </svg>
                </button>

                <!-- Toggle View -->
                <div class="view-toggle-styled"
                    style="display: flex; gap: 4px; background: #f3f4f6; padding: 4px; border-radius: 8px;">
                    <button (click)="toggleView('list')" [class.active]="viewMode === 'list'"
                        class="toggle-btn-styled">Lista</button>
                    <button (click)="toggleView('kanban')" [class.active]="viewMode === 'kanban'"
                        class="toggle-btn-styled">Kanban</button>
                </div>
            </div>
        </div>

        <!-- Search and Status Tabs -->
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <!-- Tabs -->
            <div class="status-tabs-styled"
                style="display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; max-width: 100%;">
                <button class="status-tab-styled" [class.active]="selectedStatus === 'all'"
                    (click)="setStatusFilter('all')">
                    Todos <span class="tab-count-styled">{{ statusCounts.all }}</span>
                </button>
                <button class="status-tab-styled" [class.active]="selectedStatus === 'pending'"
                    (click)="setStatusFilter('pending')">
                    Pendientes <span class="tab-count-styled">{{ statusCounts.pending }}</span>
                </button>
                <button class="status-tab-styled" [class.active]="selectedStatus === 'cooking'"
                    (click)="setStatusFilter('cooking')">
                    En Cocina <span class="tab-count-styled">{{ statusCounts.cooking }}</span>
                </button>
                <button class="status-tab-styled" [class.active]="selectedStatus === 'ready'"
                    (click)="setStatusFilter('ready')">
                    Listos <span class="tab-count-styled">{{ statusCounts.ready }}</span>
                </button>
                <button class="status-tab-styled" [class.active]="selectedStatus === 'delivered'"
                    (click)="setStatusFilter('delivered')">
                    Entregados <span class="tab-count-styled">{{ statusCounts.delivered }}</span>
                </button>
            </div>

            <!-- Search -->
            <div class="search-box-styled" style="position: relative; width: 100%; max-width: 350px;">
                <span
                    style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5;">üîç</span>
                <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearch()"
                    placeholder="Buscar por ID o Cliente..."
                    style="width: 100%; padding: 10px 10px 10px 40px; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; transition: all 0.2s; font-size: 0.9rem;">
            </div>
        </div>
    </div>

    <!-- VISTA KANBAN (Columnas) -->
    <div *ngIf="viewMode === 'kanban'" class="orders-kanban-wrapper">
        <div class="orders-kanban" cdkDropListGroup>
            <!-- Columna: Pendientes -->
            <div class="kanban-column" cdkDropList [cdkDropListData]="ordersByStatus.pending"
                (cdkDropListDropped)="onDrop($event, 'pending')">
                <div class="column-header">
                    <h3>Pendientes</h3>
                    <span class="count">{{ ordersByStatus.pending.length }}</span>
                </div>
                <div class="order-cards">
                    <div *ngFor="let order of ordersByStatus.pending" class="order-card" cdkDrag
                        [cdkDragDisabled]="order.processing" [class.active]="selectedOrder?.id === order.id"
                        (click)="selectOrder(order)">
                        <div class="card-top">
                            <span class="order-id">{{ order.id }}</span>
                            <span class="channel-icon" [class]="order.channel">{{ order.channel }}</span>
                        </div>
                        <p class="customer">{{ order.customer_name }}</p>
                        <div class="card-bottom" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                            <div style="display: flex; justify-content: space-between; width: 100%;">
                                <span class="total">${{ order.total }}</span>
                                <span class="time">{{ order.created_at | date:'shortTime' }}</span>
                            </div>
                            <span style="font-size: 0.7rem; color: #9ca3af;">{{ order.created_at | date:'dd/MM/yyyy'
                                }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna: Preparando -->
            <div class="kanban-column" cdkDropList [cdkDropListData]="ordersByStatus.cooking"
                (cdkDropListDropped)="onDrop($event, 'cooking')">
                <div class="column-header">
                    <h3>En Cocina</h3>
                    <span class="count">{{ ordersByStatus.cooking.length }}</span>
                </div>
                <div class="order-cards">
                    <div *ngFor="let order of ordersByStatus.cooking" class="order-card" cdkDrag
                        [cdkDragDisabled]="order.processing" [class.active]="selectedOrder?.id === order.id"
                        (click)="selectOrder(order)">
                        <div class="card-top">
                            <span class="order-id">{{ order.id }}</span>
                            <span class="channel-icon" [class]="order.channel">{{ order.channel }}</span>
                        </div>
                        <p class="customer">{{ order.customer_name }}</p>
                        <div class="card-bottom" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                            <div style="display: flex; justify-content: space-between; width: 100%;">
                                <span class="total">${{ order.total }}</span>
                                <span class="time">{{ order.created_at | date:'shortTime' }}</span>
                            </div>
                            <span style="font-size: 0.7rem; color: #9ca3af;">{{ order.created_at | date:'dd/MM/yyyy'
                                }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna: Listos -->
            <div class="kanban-column" cdkDropList [cdkDropListData]="ordersByStatus.ready"
                (cdkDropListDropped)="onDrop($event, 'ready')">
                <div class="column-header">
                    <h3>Listos / Enviados</h3>
                    <span class="count">{{ ordersByStatus.ready.length }}</span>
                </div>
                <div class="order-cards">
                    <div *ngFor="let order of ordersByStatus.ready" class="order-card" cdkDrag
                        [cdkDragDisabled]="order.processing" [class.active]="selectedOrder?.id === order.id"
                        (click)="selectOrder(order)">
                        <div class="card-top">
                            <span class="order-id">{{ order.id }}</span>
                            <span class="channel-icon" [class]="order.channel">{{ order.channel }}</span>
                        </div>
                        <p class="customer">{{ order.customer_name }}</p>
                        <div class="card-bottom" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                            <div style="display: flex; justify-content: space-between; width: 100%;">
                                <span class="total">${{ order.total }}</span>
                                <span class="time">{{ order.created_at | date:'shortTime' }}</span>
                            </div>
                            <span style="font-size: 0.7rem; color: #9ca3af;">{{ order.created_at | date:'dd/MM/yyyy'
                                }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detalle del Pedido Seleccionado -->
        <div class="order-detail" *ngIf="selectedOrder">
            <ng-container *ngTemplateOutlet="orderDetailTemplate"></ng-container>
        </div>
    </div>

    <!-- VISTA LISTA (Tabla con Panel de Detalles) -->
    <div *ngIf="viewMode === 'list'" class="orders-list-container">
        <!-- Lista de Pedidos -->
        <div class="orders-list-section">
            <table class="orders-table-compact">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th style="text-align: right;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let order of paginatedOrders" (click)="selectOrder(order)"
                        [class.active]="selectedOrder?.id === order.id" style="cursor: pointer;">
                        <td><strong>{{ order.id }}</strong></td>
                        <td style="font-size: 0.8rem; color: #6b7280;">
                            <div>{{ order.created_at | date:'dd/MM/yyyy' }}</div>
                            <div style="font-weight: 600;">{{ order.created_at | date:'shortTime' }}</div>
                        </td>
                        <td>{{ order.customer_name }}</td>
                        <td><strong>${{ order.total.toFixed(2) }}</strong></td>
                        <td>
                            <span class="status-badge-compact" [class]="order.status">
                                {{ getStatusLabel(order.status) }}
                            </span>
                        </td>
                        <td style="text-align: right;">
                            <button *ngIf="order.status !== 'delivered' && order.status !== 'cancelled'"
                                (click)="$event.stopPropagation(); updateStatus(order, order.status === 'pending' ? 'cooking' : (order.status === 'cooking' ? 'ready' : 'delivered'))"
                                class="quick-action-btn" [disabled]="order.processing"
                                style="padding: 4px 8px; border-radius: 6px; border: 1px solid #10b981; color: #10b981; background: white; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                {{ order.status === 'pending' ? 'üî™ Cocinar' : (order.status === 'cooking' ? 'üì¶ Listo'
                                : '‚úÖ Entregar') }}
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Pagination Footer Mejorado -->
            <div class="pagination-footer-styled"
                style="padding: 16px 24px; border-top: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; background: white; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;">
                <div class="pagination-info-styled" style="font-size: 0.85rem; color: #6b7280; font-weight: 500;">
                    Mostrando {{ filteredOrders.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0 }} - {{
                    Math.min(currentPage * itemsPerPage, filteredOrders.length) }} de {{ filteredOrders.length }}
                    pedidos
                </div>
                <div class="pagination-buttons-styled" style="display: flex; gap: 6px;">
                    <button [disabled]="currentPage === 1" (click)="setPage(currentPage - 1)" class="page-btn-styled"
                        style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer; color: #374151; font-size: 0.85rem;">Anterior</button>
                    <div style="display: flex; gap: 4px;">
                        <button *ngFor="let page of pagesArray" (click)="setPage(page)"
                            [class.active]="page === currentPage" class="page-btn-styled num-btn-styled"
                            style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; border: 1px solid #e5e7eb; background: white; color: #374151; cursor: pointer; transition: all 0.2s; font-size: 0.85rem; font-weight: 600;">
                            {{ page }}
                        </button>
                    </div>
                    <button [disabled]="currentPage === totalPages || totalPages === 0"
                        (click)="setPage(currentPage + 1)" class="page-btn-styled"
                        style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; cursor: pointer; color: #374151; font-size: 0.85rem;">Siguiente</button>
                </div>
            </div>
        </div>

        <!-- Panel de Detalles -->
        <div class="order-detail active-list" *ngIf="selectedOrder">
            <ng-container *ngTemplateOutlet="orderDetailTemplate"></ng-container>
        </div>

        <!-- Mensaje si no hay selecci√≥n -->
        <div class="order-detail empty-state" *ngIf="!selectedOrder">
            <div style="text-align: center; padding: 60px 20px; color: #9ca3af;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                    style="margin: 0 auto 16px;">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="9" x2="15" y2="9"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                <p style="font-size: 1.1rem; font-weight: 600;">Selecciona un pedido</p>
                <p style="font-size: 0.9rem; margin-top: 8px;">Haz clic en cualquier pedido de la lista para ver sus
                    detalles</p>
            </div>
        </div>
    </div>
</div>

<!-- Template Unificado para el Detalle del Pedido -->
<ng-template #orderDetailTemplate>
    <div class="detail-header" *ngIf="selectedOrder">
        <h2>Detalle del Pedido {{ selectedOrder.id }}</h2>
        <div class="status-badge" [class]="selectedOrder.status">
            {{ getStatusLabel(selectedOrder.status) }}
        </div>
    </div>

    <div class="customer-info-section" *ngIf="selectedOrder">
        <p><strong>Cliente:</strong> {{ selectedOrder.customer_name }}</p>
        <p><strong>Direcci√≥n:</strong> {{ selectedOrder.delivery_address }}</p>
        <p><strong>Canal de Venta:</strong> {{ selectedOrder.channel | uppercase }}</p>
    </div>

    <div class="items-list" *ngIf="selectedOrder">
        <h3>Productos</h3>
        <div class="item-row" *ngFor="let item of selectedOrder.items">
            <span class="qty">{{ item.quantity }}x</span>
            <span class="name">{{ item.product_name }}</span>
            <span class="price">${{ (item.unit_price * item.quantity).toFixed(2) }}</span>
        </div>
        <div class="total-row">
            <span>Total</span>
            <span class="final-price">${{ selectedOrder.total.toFixed(2) }}</span>
        </div>
    </div>

    <div class="action-buttons" *ngIf="selectedOrder">
        <button *ngIf="selectedOrder.status === 'pending'" class="primary-btn pulse"
            [disabled]="selectedOrder.processing" (click)="updateStatus(selectedOrder, 'cooking')">
            <span *ngIf="!selectedOrder.processing">üë©‚Äçüç≥ Empezar a Cocinar</span>
            <span *ngIf="selectedOrder.processing">‚åõ Procesando...</span>
        </button>
        <button *ngIf="selectedOrder.status === 'cooking'" class="primary-btn" [disabled]="selectedOrder.processing"
            (click)="updateStatus(selectedOrder, 'ready')">
            <span *ngIf="!selectedOrder.processing">üì¶ Marcar como Listo / Enviado</span>
            <span *ngIf="selectedOrder.processing">‚åõ Procesando...</span>
        </button>
        <button *ngIf="selectedOrder.status === 'ready'" class="success-btn" [disabled]="selectedOrder.processing"
            (click)="updateStatus(selectedOrder, 'delivered')">
            <span *ngIf="!selectedOrder.processing">‚úÖ Marcar como Entregado</span>
            <span *ngIf="selectedOrder.processing">‚åõ Procesando...</span>
        </button>

        <!-- Bot√≥n de Regresar -->
        <button *ngIf="selectedOrder.status !== 'pending' && selectedOrder.status !== 'delivered'" class="secondary-btn"
            [disabled]="selectedOrder.processing" (click)="moveBack(selectedOrder)">
            <span *ngIf="!selectedOrder.processing">‚Ü©Ô∏è Regresar etapa anterior</span>
            <span *ngIf="selectedOrder.processing">‚åõ Procesando...</span>
        </button>

        <button class="cancel-btn" [disabled]="selectedOrder.processing"
            (click)="updateStatus(selectedOrder, 'cancelled')">
            <span *ngIf="!selectedOrder.processing">Cancelar Pedido</span>
            <span *ngIf="selectedOrder.processing">‚åõ Cancelando...</span>
        </button>
    </div>
</ng-template>