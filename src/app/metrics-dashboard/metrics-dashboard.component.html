<div class="dashboard-container">
    <header class="dashboard-header" style="display: flex; justify-content: space-between; align-items: flex-end;">
        <div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <h1 style="margin: 0;">Panel de M√©tricas</h1>
                <!-- Mini Spinner de Carga -->
                <div *ngIf="isLoading" class="mini-spinner"></div>
            </div>
            <p>An√°lisis de rendimiento y operaci√≥n de la empresa.</p>
        </div>
        <div class="filter-buttons">
            <button class="filter-btn" [class.active]="selectedTimeRange === '24h'"
                (click)="setChartRange('24h')">24h</button>
            <button class="filter-btn" [class.active]="selectedTimeRange === '7d'"
                (click)="setChartRange('7d')">7D</button>
            <button class="filter-btn" [class.active]="selectedTimeRange === '30d'"
                (click)="setChartRange('30d')">30D</button>
            <button class="filter-btn" [class.active]="selectedTimeRange === '12m'"
                (click)="setChartRange('12m')">A√±o</button>
            <button class="filter-btn" [class.active]="selectedTimeRange === 'custom'"
                (click)="setChartRange('custom')">Personalizado</button>
        </div>
    </header>

    <!-- UI de Rango Personalizado -->
    <div *ngIf="selectedTimeRange === 'custom'"
        style="background: white; padding: 16px; border-radius: 12px; border: 1px solid #f3f4f6; margin-bottom: 24px; display: flex; align-items: center; gap: 16px; animation: slideDown 0.3s ease-out;">
        <div style="display: flex; flex-direction: column; gap: 4px;">
            <label style="font-size: 0.75rem; font-weight: 700; color: #6b7280;">DESDE</label>
            <input type="date" [(ngModel)]="customStartDate"
                style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; outline: none; font-family: inherit;">
        </div>
        <div style="display: flex; flex-direction: column; gap: 4px;">
            <label style="font-size: 0.75rem; font-weight: 700; color: #6b7280;">HASTA</label>
            <input type="date" [(ngModel)]="customEndDate"
                style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; outline: none; font-family: inherit;">
        </div>
        <button class="view-all" style="height: 38px; align-self: flex-end;" (click)="applyPeriodFilter()">
            Aplicar Filtro
        </button>
    </div>

    <ng-container *ngIf="!isLoading">
        <!-- Grid de M√©tricas Principales -->
        <div class="metrics-grid">
            <div *ngFor="let card of cards" class="metric-card">
                <div class="card-header">
                    <span class="icon">{{ card.icon }}</span>
                    <span class="change" [class.negative]="!card.isPositive">{{ card.change }}</span>
                </div>
                <div class="card-body">
                    <span class="value">{{ card.value }}</span>
                    <span class="title">{{ card.title }}</span>
                </div>
            </div>
        </div>

        <div class="dashboard-secondary-grid">
            <div class="chart-section">
                <div class="section-card">
                    <div class="header-with-actions"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">Tendencia de Ventas</h3>
                    </div>
                    <div style="height: 250px; width: 100%; position: relative;">
                        <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [type]="lineChartType">
                        </canvas>
                    </div>
                </div>

                <!-- COMPARATOR IA VS HUMANO -->
                <!-- COMPARATOR IA VS HUMANO -->
                <div class="section-card mt-20">
                    <h3>Atenci√≥n Omnicanal</h3>
                    <p class="desc-stats">Distribuci√≥n de pedidos por canal de entrada.</p>
                    <div style="height: 250px; width: 100%; position: relative;">
                        <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="barChartType">
                        </canvas>
                    </div>
                </div>

                <!-- COMPARATOR IA VS HUMANO -->
                <div class="section-card mt-20">
                    <h3>Distribuci√≥n: IA vs Humanos</h3>
                    <p class="desc-stats">Proporci√≥n de pedidos cerrados autom√°ticamente.</p>
                    <div style="height: 250px; width: 100%; position: relative;">
                        <canvas baseChart [data]="doughnutChartData" [options]="doughnutChartOptions"
                            [type]="doughnutChartType">
                        </canvas>
                    </div>
                </div>
            </div>

            <div class="section-card orders-section">
                <div class="section-header" style="flex-direction: column; align-items: stretch; gap: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0;">Pedidos Recientes</h3>
                        <span class="count-badge"
                            style="background: #eef2ff; color: #4338ca; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 800;">
                            {{ recentOrders.length }} Total
                        </span>
                    </div>

                    <!-- Campo de B√∫squeda -->
                    <div class="search-box" style="position: relative; width: 50%; max-width: 400px;">
                        <span
                            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5;">üîç</span>
                        <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearch()"
                            placeholder="Buscar por ID o Cliente..."
                            style="width: 100%; padding: 10px 10px 10px 40px; border: 1px solid #e5e7eb; border-radius: 10px; outline: none; transition: border-color 0.2s;">
                    </div>
                </div>

                <table class="orders-table" style="margin-top: 8px;">
                    <thead>
                        <tr>
                            <th (click)="toggleSort('id')" class="sortable">
                                ID
                                <span class="sort-icon" *ngIf="sortKey === 'id'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì'
                                    }}</span>
                            </th>
                            <th (click)="toggleSort('customer')" class="sortable">
                                Cliente
                                <span class="sort-icon" *ngIf="sortKey === 'customer'">{{ sortDirection === 'asc' ? '‚Üë'
                                    : '‚Üì' }}</span>
                            </th>
                            <th (click)="toggleSort('agent')" class="sortable">
                                Agente
                                <span class="sort-icon" *ngIf="sortKey === 'agent'">{{ sortDirection === 'asc' ? '‚Üë' :
                                    '‚Üì' }}</span>
                            </th>
                            <th (click)="toggleSort('total')" class="sortable">
                                Total
                                <span class="sort-icon" *ngIf="sortKey === 'total'">{{ sortDirection === 'asc' ? '‚Üë' :
                                    '‚Üì' }}</span>
                            </th>
                            <th (click)="toggleSort('status')" class="sortable">
                                Estado
                                <span class="sort-icon" *ngIf="sortKey === 'status'">{{ sortDirection === 'asc' ? '‚Üë' :
                                    '‚Üì' }}</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let order of paginatedOrders">
                            <td>{{ order.id }}</td>
                            <td>{{ order.customer }}</td>
                            <td><span class="agent-badge">{{ order.agent }}</span></td>
                            <td>${{ order.total | number:'1.2-2' }}</td>
                            <td><span class="status-badge" [class]="order.status">{{ getStatusLabel(order.status)
                                    }}</span>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Controles de Paginaci√≥n -->
                <div class="pagination-controls">
                    <div class="pagination-info">
                        Mostrando {{ (currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(currentPage * itemsPerPage,
                        recentOrders.length) }} de {{ recentOrders.length }} pedidos
                    </div>
                    <div class="pagination-buttons">
                        <button [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)"
                            class="page-btn">Anterior</button>
                        <button *ngFor="let page of pagesArray" (click)="changePage(page)"
                            [class.active]="page === currentPage" class="page-btn num-btn">
                            {{ page }}
                        </button>
                        <button [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)"
                            class="page-btn">Siguiente</button>
                    </div>
                </div>
            </div>
        </div>
    </ng-container>
</div>