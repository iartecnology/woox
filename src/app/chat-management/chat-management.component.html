<div class="chat-dashboard">

  <!-- PANEL 1: LISTA DE CHATS -->
  <aside class="panel-list">
    <div class="panel-header">
      <div class="header-top">
        <h2 class="panel-title">Chats</h2>
        <div class="header-actions" style="display: flex; gap: 6px;">
          <button class="icon-btn" (click)="loadConversations()" title="Recargar"
            style="background: #10b981; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
              <polyline points="21 3 21 8 16 8"></polyline>
            </svg>
          </button>
          <button *ngIf="canDelete" class="icon-btn" (click)="deleteAllConversations()" title="Eliminar TODOS los chats"
            style="background: #ef4444; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"
              stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Inbox Tabs (Chatwoot style) -->
      <div class="inbox-tabs">
        <div class="tab" [class.active]="inboxTab === 'mine'" (click)="setInboxTab('mine')">M√≠os</div>
        <div class="tab" [class.active]="inboxTab === 'unassigned'" (click)="setInboxTab('unassigned')">Sin Asignar
        </div>
        <div class="tab" [class.active]="inboxTab === 'all'" (click)="setInboxTab('all')">Todos</div>
      </div>

      <div class="search-bar" style="margin-bottom: 8px;">
        <span>üîç</span>
        <input type="text" [(ngModel)]="searchQuery" placeholder="Buscar cliente o mensaje...">
      </div>

      <div class="channel-filters">
        <div class="filter-pill" [class.active]="selectedChannel === 'all'" (click)="setFilter('all')">Todos</div>
        <div class="filter-pill" [class.active]="selectedChannel === 'whatsapp'" (click)="setFilter('whatsapp')">
          WhatsApp</div>
        <div class="filter-pill" [class.active]="selectedChannel === 'telegram'" (click)="setFilter('telegram')">
          Telegram</div>
        <div class="filter-pill" [class.active]="selectedChannel === 'instagram'" (click)="setFilter('instagram')">
          Instagram</div>
        <div class="filter-pill" [class.active]="selectedChannel === 'messenger'" (click)="setFilter('messenger')">
          Messenger</div>
        <div class="filter-pill" [class.active]="selectedChannel === 'simulator'" (click)="setFilter('simulator')">
          Pruebas üöÄ</div>
      </div>
    </div>

    <div class="conversation-list" style="overflow-y: auto; flex: 1; position: relative;">
      <!-- Spinner Lista -->
      <div *ngIf="isLoadingList"
        style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 0; color: #64748b; gap: 12px;">
        <div class="spinner-premium" style="width: 32px; height: 32px;"></div>
        <span style="font-size: 0.8rem; font-weight: 700;">Cargando chats...</span>
      </div>

      <div *ngIf="!isLoadingList">
        <div *ngFor="let conv of filteredConversations; trackBy: trackByConversationId" class="conversation-item"
          [class.active]="selectedConversation?.id === conv.id" [class.just-updated]="conv.justUpdated"
          (click)="selectConversation(conv)">

          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <span style="font-weight: 700; color: #065f46; font-size: 0.95rem;">{{ conv.customer_name }}</span>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button *ngIf="canDelete" type="button"
                (click)="$event.stopPropagation(); deleteConversation(conv.id, $event)"
                style="background: none; border: none; padding: 4px; cursor: pointer; opacity: 0.5; font-size: 0.9rem;"
                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'" title="Eliminar chat">
                üóëÔ∏è
              </button>
              <span style="font-size: 0.7rem; color: #94a3b8; font-weight: 600;">{{ conv.last_message_at | date:'HH:mm'
                }}</span>
            </div>
          </div>

          <div style="display: flex; align-items: center; gap: 6px;">
            <span class="platform-indicator" [ngClass]="conv.channel">
              {{ conv.channel }}
            </span>
            <p
              style="margin: 0; font-size: 0.85rem; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1;">
              {{ conv.last_message }}
            </p>
            <div *ngIf="conv.unread_count > 0"
              style="width: 18px; height: 18px; background: #ef4444; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 800;">
              {{ conv.unread_count }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- PANEL 2: CHAT ACTIVO -->
  <main class="panel-chat" style="position: relative;">
    <!-- Overlay de Carga Detalles -->
    <div *ngIf="isLoadingDetails"
      style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; backdrop-filter: blur(2px);">
      <div class="spinner-premium"></div>
      <p style="font-weight: 800; color: #6d28d9; letter-spacing: 0.5px;">Cargando conversaci√≥n...</p>
    </div>
    <ng-container *ngIf="selectedConversation; else noChat">
      <header class="chat-banner">
        <div class="customer-info">
          <div class="customer-avatar">
            {{ selectedConversation.customer_name.charAt(0) }}
          </div>
          <div class="customer-details">
            <h3 class="customer-name">{{ selectedConversation.customer_name }}</h3>
            <span class="customer-status">
              {{ selectedConversation.channel | titlecase }} ‚Ä¢ {{ selectedConversation.status | uppercase }}
              <button *ngIf="!selectedConversation.assigned_agent_id" (click)="claimConversation()"
                style="margin-left: 8px; font-size: 0.65rem; background: #7c3aed; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-weight: 700;">
                Tomar control
              </button>
            </span>
          </div>
        </div>

        <div class="chat-actions">
          <div class="ai-banner">
            <span class="ai-label">ü§ñ IA Activa</span>
            <label class="switch">
              <input type="checkbox" [checked]="selectedConversation.ai_active" (change)="toggleAI()">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </header>

      <div class="messages-container" #chatBody>
        <div *ngFor="let msg of selectedConversation.messages" class="msg-wrapper"
          [class.sent]="msg.sender_type !== 'customer'" [class.received]="msg.sender_type === 'customer'">

          <div class="bubble" [class.agent]="msg.sender_type === 'human_agent'" [class.ai]="msg.sender_type === 'ai'"
            [innerHTML]="formatMessage(msg.content)">
          </div>
          <span style="font-size: 0.6rem; color: #94a3b8; margin-top: 4px; font-weight: 600;">
            {{ msg.created_at | date:'HH:mm' }} ‚Ä¢ {{ getSenderName(msg) | uppercase }}
          </span>
        </div>

        <!-- Typing Indicator -->
        <div *ngIf="isAgentTyping" style="font-size: 0.75rem; color: #64748b; padding: 10px; font-style: italic;">
          {{ typingAgentName }} est√° escribiendo... ‚úçÔ∏è
        </div>
      </div>

      <footer class="chat-footer" [class.internal-mode]="isInternalNote">
        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
          <button (click)="isInternalNote = false" [style.background]="!isInternalNote ? '#e8f5e9' : 'none'"
            [style.color]="!isInternalNote ? '#2e7d32' : '#64748b'"
            style="border: none; padding: 4px 12px; border-radius: 100px; font-size: 0.7rem; font-weight: 800; cursor: pointer;">
            MENSAJE
          </button>
          <button (click)="isInternalNote = true" [style.background]="isInternalNote ? '#fff3e0' : 'none'"
            [style.color]="isInternalNote ? '#ef6c00' : '#64748b'"
            style="border: none; padding: 4px 12px; border-radius: 100px; font-size: 0.7rem; font-weight: 800; cursor: pointer;">
            NOTA INTERNA üîí
          </button>
        </div>
        <div class="input-box">
          <button style="background: transparent; border: none; font-size: 1.2rem; cursor: pointer;">üìé</button>
          <input type="text" [(ngModel)]="newMessage" (keyup.enter)="sendMessage()" (input)="onInputChange()"
            [placeholder]="isInternalNote ? 'Escribir nota privada (solo equipo)...' : 'Escribe un mensaje aqu√≠...'">
          <button class="send-btn" (click)="sendMessage()">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
          </button>
        </div>
      </footer>
    </ng-container>

    <ng-template #noChat>
      <div
        style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f0fdf4; color: #059669;">
        <div style="font-size: 5rem; margin-bottom: 24px; opacity: 0.3;">üí¨</div>
        <h2 style="font-weight: 800;">Selecciona un chat</h2>
        <p>Tu centro de atenci√≥n omnicanal est√° listo.</p>
        <button (click)="openSimulator()" class="btn-primary"
          style="margin-top: 16px; padding: 12px 24px; border-radius: 12px; border: none; color: white; font-weight: 700; cursor: pointer;">Abrir
          Simulador</button>
      </div>
    </ng-template>
  </main>

  <!-- PANEL 3: CRM / INFO -->
  <aside class="panel-crm" *ngIf="selectedConversation">
    <div class="crm-section">
      <div class="crm-section-title">Informaci√≥n del Cliente</div>
      <div class="info-grid">
        <div class="info-item">
          <label>Nombre Completo</label>
          <input type="text" [(ngModel)]="customerCRM.full_name" (blur)="saveCRM()" placeholder="Juan P√©rez">
        </div>
        <div class="info-item">
          <label>Tel√©fono</label>
          <input type="text" [(ngModel)]="customerCRM.phone" (blur)="saveCRM()" placeholder="+57...">
        </div>
        <div class="info-item">
          <label>Email</label>
          <input type="email" [(ngModel)]="customerCRM.email" (blur)="saveCRM()" placeholder="cliente@email.com">
        </div>
        <div class="info-item">
          <label>Ubicaci√≥n</label>
          <input type="text" [(ngModel)]="customerCRM.city" (blur)="saveCRM()" placeholder="Ciudad, Pa√≠s">
        </div>
      </div>
    </div>

    <div class="crm-section">
      <div class="crm-section-title" style="display: flex; justify-content: space-between; align-items: center;">
        Etiquetas
        <button (click)="showTagMenu = !showTagMenu"
          style="background: none; border: none; color: #7c3aed; font-weight: 800; cursor: pointer; font-size: 0.7rem;">+
          A√ëADIR</button>
      </div>
      <div class="tag-container" style="margin-top: 8px;">
        <div *ngFor="let msgTag of currentTags" class="tag-pill" [style.background]="msgTag.color"
          style="color: white; padding: 4px 10px; border-radius: 100px; font-size: 0.7rem; font-weight: 800; display: inline-flex; align-items: center; gap: 4px;">
          {{ msgTag.name }}
          <span (click)="removeTag(msgTag.id)" style="cursor: pointer; opacity: 0.8;">√ó</span>
        </div>
      </div>
    </div>

    <div class="crm-section">
      <div class="crm-section-title">Notas Internas</div>
      <div class="notes-list">
        <div *ngFor="let note of internalNotes" class="note-card">
          {{ note.content }}
          <div class="note-date">{{ note.created_at | date:'dd MMM, HH:mm' }}</div>
        </div>
      </div>
      <div class="info-item note-input">
        <input type="text" [(ngModel)]="newNote" (keyup.enter)="saveNote()" placeholder="Escribir nota privada...">
      </div>
    </div>

    <div class="crm-footer">
      <button class="order-btn" (click)="openOrderModal()">
        üõí Crear Pedido
      </button>

      <div class="vip-stats">
        <div class="vip-stats-title">Estad√≠sticas VIP</div>
        <div class="stats-row">
          <div class="stat-group">
            <div class="stat-val">{{ customerCRM.orders_count || 0 }}</div>
            <div class="stat-label">Pedidos</div>
          </div>
          <div class="stat-group">
            <div class="stat-val">$ {{ customerCRM.total_spent | number:'1.0-2' }}</div>
            <div class="stat-label">Gasto Total</div>
          </div>
        </div>
      </div>
    </div>
  </aside>

</div>

<!-- SIMULADOR -->
<app-chat-simulator *ngIf="showSimulator && merchantData" [merchantName]="merchantData.name" [merchantId]="merchantId"
  [logoUrl]="merchantData.logo_url || ''" [primaryColor]="merchantData.primary_color || '#10b981'"
  [aiProvider]="merchantData.ai_provider || 'google_gemini'" [aiApiKey]="merchantData.ai_api_key || ''"
  [aiModel]="merchantData.ai_model || ''" [aiWelcomeMessage]="merchantData.ai_welcome_message || ''"
  [context]="getConsolidatedPrompt()" (onClose)="showSimulator = false; loadConversations()">
</app-chat-simulator>

<!-- MODAL DE CREACI√ìN DE PEDIDO -->
<div class="order-modal-overlay" *ngIf="showOrderModal">
  <div class="order-modal">
    <header class="modal-header">
      <h2 style="font-weight: 800; margin: 0; color: #065f46;">üöÄ Crear Nuevo Pedido</h2>
      <button (click)="showOrderModal = false"
        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">√ó</button>
    </header>

    <div class="modal-body">
      <!-- Selector de Productos -->
      <div class="product-selection-area">
        <div class="product-search-box">
          <input type="text" [(ngModel)]="productSearchQuery" placeholder="üîç Buscar producto por nombre o categor√≠a..."
            style="width: 100%; padding: 12px 16px; border: 2px solid #f1f5f9; border-radius: 12px; font-size: 0.9rem; outline: none; transition: border-color 0.2s;">
        </div>

        <div class="products-scroll-container">
          <!-- Spinner de Carga -->
          <div *ngIf="isLoadingProducts" class="products-loading-state">
            <div class="spinner-premium"></div>
            <p>Cargando cat√°logo...</p>
          </div>

          <ng-container *ngIf="!isLoadingProducts">
            <div *ngFor="let group of filteredGroupedProducts" class="category-group">
              <h3 class="category-header">{{ group.category }}</h3>
              <div class="product-grid">
                <div *ngFor="let p of group.products" class="product-card-premium" (click)="addToOrder(p)">
                  <div class="product-img-mini" *ngIf="p.image_url"
                    [style.backgroundImage]="'url(' + p.image_url + ')'">
                  </div>
                  <div class="product-img-mini no-img" *ngIf="!p.image_url">üì¶</div>
                  <div class="product-info-mini">
                    <div class="p-name">{{ p.name }}</div>
                    <div class="p-price">$ {{ p.price }}</div>
                  </div>
                  <div class="add-indicator">+</div>
                </div>
              </div>
            </div>

            <div *ngIf="filteredGroupedProducts.length === 0"
              style="text-align: center; padding: 40px; color: #94a3b8;">
              <p>No se encontraron productos con ese nombre.</p>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Resumen del Pedido -->
      <aside class="order-summary-sidebar">
        <div class="summary-header">
          <h3>üí∞ Resumen</h3>
          <span class="items-count">{{ orderDraft.length }} productos</span>
        </div>

        <div class="summary-list">
          <div *ngFor="let item of orderDraft" class="summary-item">
            <div style="flex: 1;">
              <div style="font-weight: 700; font-size: 0.85rem; color: #334155;">{{ item.product.name }}</div>
              <div style="font-size: 0.75rem; color: #94a3b8;">$ {{ item.product.price }} c/u</div>
            </div>
            <div class="qty-controls">
              <button class="qty-btn" (click)="updateQty(item.product.id, -1)">-</button>
              <span style="font-weight: 800; font-size: 0.9rem; min-width: 24px; text-align: center; color: #065f46;">
                {{ item.quantity }}
              </span>
              <button class="qty-btn" (click)="updateQty(item.product.id, 1)">+</button>
            </div>
          </div>

          <div *ngIf="orderDraft.length === 0" class="empty-cart-state">
            <div class="empty-icon">üõí</div>
            <p>Selecciona productos a la izquierda para armar el pedido</p>
          </div>
        </div>

        <div class="summary-footer">
          <div class="total-row">
            <span>Total a pagar</span>
            <span class="total-amount">$ {{ orderTotal | number:'1.0-2' }}</span>
          </div>
          <button class="btn-confirm-order" [disabled]="orderDraft.length === 0" (click)="submitOrder()">
            <span *ngIf="!isDeleting">Confirmar Pedido ($ {{ orderTotal }})</span>
            <span *ngIf="isDeleting">Generando...</span>
          </button>
        </div>
      </aside>
    </div>
  </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN DE ELIMINACI√ìN -->
<div class="order-modal-overlay" *ngIf="showDeleteModal">
  <div class="delete-modal">
    <div class="delete-icon-wrapper">
      üóëÔ∏è
    </div>
    <h3>{{ deleteMode === 'single' ? '¬øEliminar chat?' : '¬øEliminar TODOS los chats?' }}</h3>
    <p>
      {{ deleteMode === 'single' ? 'Esta acci√≥n no se puede deshacer. Se perder√° el historial de esta conversaci√≥n.' :
      'Esta acci√≥n no se puede deshacer. Se borrar√° todo el historial de chats de este comercio.' }}
    </p>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="cancelDelete()" [disabled]="isDeleting">Cancelar</button>
      <button class="btn-delete" (click)="confirmDelete()" [disabled]="isDeleting">
        {{ isDeleting ? 'Eliminando...' : 'S√≠, eliminar' }}
      </button>
    </div>
  </div>
</div>